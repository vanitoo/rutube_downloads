# KODA.md โ ะะฝััััะบัะธะธ ะดะปั AI-ะฐััะธััะตะฝัะฐ

## ะะฑะทะพั ะฟัะพะตะบัะฐ

**Rutube Downloader** โ ััะพ Python-ะฟัะธะปะพะถะตะฝะธะต ั ะณัะฐัะธัะตัะบะธะผ ะธะฝัะตััะตะนัะพะผ (tkinter) ะดะปั ัะบะฐัะธะฒะฐะฝะธั ะฒะธะดะตะพ ั ะบะฐะฝะฐะปะพะฒ Rutube. ะัะพะณัะฐะผะผะฐ ะฟะพะทะฒะพะปัะตั ะทะฐะณััะถะฐัั ะฒะธะดะตะพ, ะพะฟะธัะฐะฝะธั ะธ ะผะธะฝะธะฐัััั ั ัะพััะฐะฝะตะฝะธะตะผ ะผะตัะฐะดะฐะฝะฝัั.

**ะะตััะธั:** 0.6  
**ะขะตัะฝะพะปะพะณะธะธ:** Python 3, tkinter, yt-dlp, Selenium, requests  
**ะััะธัะตะบัััะฐ:** MVC ั ัะฐะทะดะตะปะตะฝะธะตะผ ะฝะฐ ะผะพะดัะปะธ (downloader, functions, gui, logger)

---

## ะกัััะบัััะฐ ะฟัะพะตะบัะฐ

```
โโโ main.py              # ะขะพัะบะฐ ะฒัะพะดะฐ
โโโ start.cmd            # ะกะบัะธะฟั ะทะฐะฟััะบะฐ (Windows)
โโโ README.md            # ะะพะบัะผะตะฝัะฐัะธั ะฟัะพะตะบัะฐ
โโโ KODA.md              # ะญัะธ ะธะฝััััะบัะธะธ
โโโ rutube_downloader.py # ะะพะณะธะบะฐ ะทะฐะณััะทะบะธ (ะบะปะฐัั RutubeDownloader)
โโโ rutube_functions.py   # ะัะฟะพะผะพะณะฐัะตะปัะฝัะต ััะฝะบัะธะธ
โโโ rutube_gui.py        # ะัะฐัะธัะตัะบะธะน ะธะฝัะตััะตะนั (ะบะปะฐัั RutubeGUI)
โโโ rutube_logger.py     # ะกะธััะตะผะฐ ะปะพะณะธัะพะฒะฐะฝะธั
โโโ rutube_config.json   # ะะพะฝัะธะณััะฐัะธั ะฟะพะปัะทะพะฒะฐัะตะปั
โโโ requirements.txt     # ะะฐะฒะธัะธะผะพััะธ
โโโ .history/            # ะััะพัะธั ะธะทะผะตะฝะตะฝะธะน
โโโ rutube_downloads/    # ะะฐะฟะบะฐ ะดะปั ะทะฐะณััะทะพะบ (ัะพะทะดะฐัััั ะฟัะธ ัะฐะฑะพัะต)
```

---

## ะกะฑะพัะบะฐ ะธ ะทะฐะฟััะบ

### ะขัะตะฑะพะฒะฐะฝะธั
- Python 3.8+
- Google Chrome (ะดะปั Selenium)
- ChromeDriver (ัััะฐะฝะฐะฒะปะธะฒะฐะตััั ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะตัะตะท webdriver_manager)

### ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน

```bash
# ะกะพะทะดะฐะฝะธะต ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั
python -m venv .venv

# ะะบัะธะฒะฐัะธั (Windows)
.venv\Scripts\activate

# ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
pip install -r requirements.txt
```

### ะะฐะฟััะบ

```bash
# ะงะตัะตะท ัะบัะธะฟั (Windows)
start.cmd

# ะะปะธ ะฝะฐะฟััะผัั
python main.py
```

### ะคะฐะนะป requirements.txt

```
colorama==0.4.6
requests==2.31.0
yt-dlp==2024.x.x
selenium==4.x.x
webdriver-manager==4.x.x
tk
```

---

## ะััะธัะตะบัััะฐ ะธ ะผะพะดัะปะธ

### main.py
ะขะพัะบะฐ ะฒัะพะดะฐ ะฟัะธะปะพะถะตะฝะธั. ะะฝะธัะธะฐะปะธะทะธััะตั ะปะพะณะณะตั ะธ ะทะฐะฟััะบะฐะตั GUI.

**ะะปััะตะฒัะต ััะฝะบัะธะธ:**
- ะะฐัััะพะนะบะฐ ะปะพะณะณะตัะฐ ั ะฟะฐัะฐะผะตััะฐะผะธ ะธะท ะบะพะฝัะธะณััะฐัะธะธ
- ะกะพะทะดะฐะฝะธะต ัะบะทะตะผะฟะปััะฐ RutubeDownloader
- ะะฐะฟััะบ GUI ัะตัะตะท create_gui()

### rutube_downloader.py โ RutubeDownloader

ะัะฝะพะฒะฝะพะน ะบะปะฐัั ะปะพะณะธะบะธ ะทะฐะณััะทะบะธ.

**ะััะธะฑััั:**
```python
self.output_dir              # ะะฐะฟะบะฐ ะดะปั ะทะฐะณััะทะพะบ
self.last_folder            # ะขะตะบััะฐั ะฟะฐะฟะบะฐ ะบะฐะฝะฐะปะฐ
self._cancel_flag           # ะคะปะฐะณ ะพัะผะตะฝั ะทะฐะณััะทะบะธ
self._cancel_lock           # Lock ะดะปั ะฟะพัะพะบะพะฑะตะทะพะฟะฐัะฝะพััะธ
self._status_callback       # Callback ะดะปั GUI
self.concurrent_fragment_count  # ะะพัะพะบะพะฒ ะฝะฐ ัะฐะนะป
self.max_workers            # ะะฐัะฐะปะปะตะปัะฝัั ะทะฐะณััะทะพะบ
```

**ะะปััะตะฒัะต ะผะตัะพะดั:**
| ะะตัะพะด | ะะฟะธัะฐะฝะธะต |
|-------|----------|
| `get_video_links(url)` | ะะพะปััะฐะตั ัะฟะธัะพะบ ัััะปะพะบ ะฝะฐ ะฒะธะดะตะพ ะบะฐะฝะฐะปะฐ |
| `fetch_all_metadata(links)` | ะะฐะณััะถะฐะตั ะผะตัะฐะดะฐะฝะฝัะต ะฒัะตั ะฒะธะดะตะพ |
| `process_video2(meta_with_index)` | ะะฑัะฐะฑะฐััะฒะฐะตั ะพะดะฝะพ ะฒะธะดะตะพ (ะฝะพะฒัะน ัะพัะผะฐั) |
| `download_all(metadata_list)` | ะะฐะฟััะบะฐะตั ะฟะฐัะฐะปะปะตะปัะฝัั ะทะฐะณััะทะบั |
| `cancel_download()` | ะฃััะฐะฝะฐะฒะปะธะฒะฐะตั ัะปะฐะณ ะพัะผะตะฝั |

### rutube_functions.py

ะัะฟะพะผะพะณะฐัะตะปัะฝัะต ััะฝะบัะธะธ ะดะปั ัะฐะฑะพัั ั ะฒะธะดะตะพ.

**ะะปััะตะฒัะต ััะฝะบัะธะธ:**
| ะคัะฝะบัะธั | ะะฟะธัะฐะฝะธะต |
|---------|----------|
| `get_video_links(channel_url)` | ะะฐััะธั ัััะฐะฝะธัั ะบะฐะฝะฐะปะฐ ัะตัะตะท Selenium |
| `fetch_metadata(video_url)` | ะะพะปััะฐะตั ะผะตัะฐะดะฐะฝะฝัะต ะฒะธะดะตะพ ัะตัะตะท yt-dlp |
| `download_video(meta, folder, prefix)` | ะกะบะฐัะธะฒะฐะตั ะฒะธะดะตะพ ั retry |
| `save_description(title, desc, folder, prefix)` | ะกะพััะฐะฝัะตั ะพะฟะธัะฐะฝะธะต ะฒ .txt |
| `save_thumbnail(title, url, folder, prefix)` | ะกะพััะฐะฝัะตั ะพะฑะปะพะถะบั ะฒ .jpg |
| `save_metadata_csv(metas, folder)` | ะญะบัะฟะพัั ะผะตัะฐะดะฐะฝะฝัั ะฒ CSV |

**ะัะพะฑะตะฝะฝะพััะธ:**
- ะคัะฝะบัะธั `download_video()` ัะตะฐะปะธะทัะตั retry-ะปะพะณะธะบั ั ัะบัะฟะพะฝะตะฝัะธะฐะปัะฝะพะน ะทะฐะดะตัะถะบะพะน (2ั, 5ั, 10ั)
- ะคัะฝะบัะธั `save_description()` ะปะพะณะธััะตั ััะฟะตั/ะพัะธะฑะบั
- ะััะธัะพะฒะฐะฝะธะต ะผะตัะฐะดะฐะฝะฝัั ะฒ `metadata.json`

### rutube_gui.py โ RutubeGUI

ะะปะฐัั ะณัะฐัะธัะตัะบะพะณะพ ะธะฝัะตััะตะนัะฐ ะฝะฐ tkinter.

**ะััะธะฑััั:**
```python
self.window          # ะะปะฐะฒะฝะพะต ะพะบะฝะพ tk.Tk
self.tree            # ะขะฐะฑะปะธัะฐ ะฒะธะดะตะพ (ttk.Treeview)
self.row_refs        # ะกะฟะธัะพะบ ID ัััะพะบ ัะฐะฑะปะธัั
self.current_metas  # ะขะตะบััะธะต ะผะตัะฐะดะฐะฝะฝัะต ะฒะธะดะตะพ
self.downloader      # ะญะบะทะตะผะฟะปัั RutubeDownloader
```

**ะกัััะบัััะฐ ะธะฝัะตััะตะนัะฐ:**
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ [URL] [ะะพะปััะธัั ัะฟะธัะพะบ] [ะกะบะฐัะฐัั] [ะััะฐะฝะพะฒะธัั] [ะะฐัััะพะนะบะธ] โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ะะฐะฟะบะฐ ะทะฐะณััะทะบะธ: [__________] [๐] [ะัะฑัะฐัั ะฒัะต] โ          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ [ะัะพะณัะตัั-ะฑะฐั]                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ # | ะะฐะทะฒะฐะฝะธะต         | ะะฐัะฐ    | ะัะตะผั | ะกัะฐััั  | โ       โ
โ 1 | ะะธะดะตะพ 1          | 2025.01 | 10:00 | โณ      | โ       โ
โ 2 | ะะธะดะตะพ 2          | 2025.01 | 15:30 | โ ะะพัะพะฒะพ| โ       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ [ะะพะฝัะพะปั ะปะพะณะพะฒ]                                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ะะพะฝััะฐะฝัั:**
```python
CHECKBOX_COLUMN = "#7"  # ะะพะปะพะฝะบะฐ ั ัะตะบะฑะพะบัะพะผ ะฒัะฑะพัะฐ
```

**ะะปััะตะฒัะต ะผะตัะพะดั:**
| ะะตัะพะด | ะะฟะธัะฐะฝะธะต |
|-------|----------|
| `_on_get_list()` | ะะฐะปะธะดะฐัะธั URL + ะทะฐะฟััะบ ะฟะพะปััะตะฝะธั ัะฟะธัะบะฐ |
| `_on_download()` | ะะฐะฟััะบ ัะบะฐัะธะฒะฐะฝะธั ะฒ ะพัะดะตะปัะฝะพะผ ะฟะพัะพะบะต |
| `_check_existing_files(channel)` | Batch-ะฟัะพะฒะตัะบะฐ ัััะตััะฒัััะธั ัะฐะนะปะพะฒ |
| `_safe_update_table(metas, channel)` | ะะพัะพะบะพะฑะตะทะพะฟะฐัะฝะพะต ะพะฑะฝะพะฒะปะตะฝะธะต ัะฐะฑะปะธัั |
| `_update_ui_state()` | ะะปะพะบะธัะพะฒะบะฐ ะบะฝะพะฟะพะบ ะฟัะธ ะทะฐะณััะทะบะต |

### rutube_logger.py โ UniversalLogger

ะกะธััะตะผะฐ ะปะพะณะธัะพะฒะฐะฝะธั ั ะฟะพะดะดะตัะถะบะพะน:
- ะฆะฒะตัะฝะพะณะพ ะฒัะฒะพะดะฐ ะฒ ะบะพะฝัะพะปั
- ะัะฒะพะดะฐ ะฒ GUI-ะฒะธะดะถะตั
- ะะพัะฐัะธะธ ัะฐะนะปะพะฒ (10 MB, 5 ัะตะทะตัะฒะฝัั ะบะพะฟะธะน)
- ะคะธะปัััะฐัะธะธ ัะพะพะฑัะตะฝะธะน ะฟัะพะณัะตััะฐ yt-dlp

**ะฃัะพะฒะฝะธ ะปะพะณะธัะพะฒะฐะฝะธั:**
- DEBUG: ะพัะปะฐะดะพัะฝะฐั ะธะฝัะพัะผะฐัะธั
- INFO: ะพัะฝะพะฒะฝัะต ัะพะฑััะธั
- WARNING: ะฟัะตะดัะฟัะตะถะดะตะฝะธั
- ERROR: ะพัะธะฑะบะธ
- CRITICAL: ะบัะธัะธัะตัะบะธะต ะพัะธะฑะบะธ

---

## ะคะพัะผะฐั ะดะฐะฝะฝัั

### ะะตัะฐะดะฐะฝะฝัะต ะฒะธะดะตะพ (ะธะท yt-dlp)
```python
{
    "id": "uuid",
    "title": "ะะฐะทะฒะฐะฝะธะต ะฒะธะดะตะพ",
    "description": "ะขะตะบัั ะพะฟะธัะฐะฝะธั",
    "upload_date": "20250115",  # YYYYMMDD
    "duration_string": "10:25", # H:MM ะธะปะธ MM:SS
    "thumbnail": "https://...",
    "webpage_url": "https://rutube.ru/video/..."
}
```

### ะคะฐะนะปะพะฒะฐั ััััะบัััะฐ ะทะฐะณััะทะพะบ
```
rutube_downloads/
โโโ <ะะฐะทะฒะฐะฝะธะต ะบะฐะฝะฐะปะฐ>/
    โโโ 2025.01.15_1025_ะะฐะทะฒะฐะฝะธะต ะฒะธะดะตะพ.mp4
    โโโ 2025.01.15_1025_ะะฐะทะฒะฐะฝะธะต ะฒะธะดะตะพ.txt
    โโโ 2025.01.15_1025_ะะฐะทะฒะฐะฝะธะต ะฒะธะดะตะพ.jpg
    โโโ metadata.csv
```

### ะะพะฝัะธะณััะฐัะธั (rutube_config.json)
```json
{
    "last_url": "https://rutube.ru/channel/...",
    "download_folder": "rutube_downloads",
    "concurrent_fragment_count": 4,
    "max_workers": 1
}
```

---

## ะกะพะณะปะฐัะตะฝะธั ะธ ะฟัะฐะฒะธะปะฐ

### ะกัะธะปั ะบะพะดะฐ

1. **ะะผะตะฝะพะฒะฐะฝะธะต:**
   - ะคัะฝะบัะธะธ: `snake_case`
   - ะะปะฐััั: `PascalCase`
   - ะะพะฝััะฐะฝัั ะฒ ะบะปะฐััะฐั: `UPPER_SNAKE_CASE` (ะฝะฐะฟัะธะผะตั, `CHECKBOX_COLUMN`)

2. **ะะพะบัะผะตะฝัะฐัะธั:**
   - ะะฐะถะดัะน ะฟัะฑะปะธัะฝัะน ะผะตัะพะด ะธะผะตะตั docstring
   - ะะพะผะผะตะฝัะฐัะธะธ ะฝะฐ ััััะบะพะผ ัะทัะบะต
   - ะะพะณะธัะพะฒะฐะฝะธะต ะฝะฐ ััััะบะพะผ ัะทัะบะต

3. **ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ:**
   - ะัะต ะฒะฝะตัะฝะธะต ะฒัะทะพะฒั ะพะฑะพัะฐัะธะฒะฐัััั ะฒ try-except
   - ะัะธะฑะบะธ ะปะพะณะธัััััั ัะตัะตะท logger.error()
   - ะะพะปัะทะพะฒะฐัะตะปั ะฒะธะดะธั messagebox ะฟัะธ ะบัะธัะธัะตัะบะธั ะพัะธะฑะบะฐั

4. **ะะพัะพะบะพะฑะตะทะพะฟะฐัะฝะพััั:**
   - ะะปะธัะตะปัะฝัะต ะพะฟะตัะฐัะธะธ ะฒัะฟะพะปะฝััััั ะฒ ะพัะดะตะปัะฝัั ะฟะพัะพะบะฐั
   - GUI ะพะฑะฝะพะฒะปัะตััั ัะตัะตะท after() ะธะปะธ thread-safe ะผะตัะพะดั
   - ะะฑัะธะต ัะตััััั ะทะฐัะธัะฐัััั ัะตัะตะท Lock

### ะขะตะบััะธะต ะธะทะฒะตััะฝัะต ะฟัะพะฑะปะตะผั

1. **ะฃัะตัะบะฐ ะฟะฐะผััะธ:** ะกะฟะธัะพะบ `row_refs` ะฝะต ะพัะธัะฐะตััั ะฟัะธ ะพัะธะฑะบะฐั ะพะฑะฝะพะฒะปะตะฝะธั ัะฐะฑะปะธัั
2. **ะะพะฝะบะธ ะดะฐะฝะฝัั:** `_cancel_flag` ััะตะฑัะตั Lock (ัะถะต ะดะพะฑะฐะฒะปะตะฝ ะฒ __init__)
3. **ะััััััะฒัะตั ัะธะปัััะฐัะธั:** ะะตั ัะธะปัััะฐัะธะธ ะฒะธะดะตะพ ะฟะพ ะดะฐัะต/ะดะปะธัะตะปัะฝะพััะธ/ะฝะฐะทะฒะฐะฝะธั

### ะขะตะบััะธะต ัะปัััะตะฝะธั ะฒ ัะฐะทัะฐะฑะพัะบะต

1. **Retry-ะปะพะณะธะบะฐ:** ะะตะฐะปะธะทะพะฒะฐะฝะฐ ะฒ `download_video()` ั ัะบัะฟะพะฝะตะฝัะธะฐะปัะฝะพะน ะทะฐะดะตัะถะบะพะน
2. **Batch-ะฟัะพะฒะตัะบะฐ ัะฐะนะปะพะฒ:** `_check_existing_files()` ะธัะฟะพะปัะทัะตั os.scandir() ะฒะผะตััะพ ะผะฝะพะถะตััะฒะตะฝะฝัั os.path.exists()
3. **ะะฐะปะธะดะฐัะธั URL:** ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั "rutube.ru" ะฒ ัััะปะบะต

---

## ะขะธะฟะธัะฝัะต ะทะฐะดะฐัะธ

### ะะพะฑะฐะฒะปะตะฝะธะต ะฝะพะฒะพะน ััะฝะบัะธะธ

1. ะะฟัะตะดะตะปะธัั ะผะพะดัะปั (gui/downloader/functions)
2. ะะพะฑะฐะฒะธัั ััะฝะบัะธั/ะผะตัะพะด ั docstring
3. ะะพะฑะฐะฒะธัั ะพะฑัะฐะฑะพัะบั ะพัะธะฑะพะบ
4. ะะฐะดะพะบัะผะตะฝัะธัะพะฒะฐัั ะฒ KODA.md

### ะัะฟัะฐะฒะปะตะฝะธะต ะพัะธะฑะบะธ

1. ะะพัะฟัะพะธะทะฒะตััะธ ะพัะธะฑะบั
2. ะะฐะนัะธ ัะพะพัะฒะตัััะฒัััะธะน ะผะพะดัะปั
3. ะะพะฑะฐะฒะธัั try-except ั ะปะพะณะธัะพะฒะฐะฝะธะตะผ
4. ะัะพะฒะตัะธัั ัะฐะฑะพัั

### ะะทะผะตะฝะตะฝะธะต GUI

1. ะะทะผะตะฝััั ัะพะปัะบะพ ะฒ `rutube_gui.py`
2. ะัะฟะพะปัะทะพะฒะฐัั ะบะพะฝััะฐะฝัั ะดะปั ะผะฐะณะธัะตัะบะธั ัะธัะตะป
3. ะัะพะฒะตัััั ะฟะพัะพะบะพะฑะตะทะพะฟะฐัะฝะพััั ะพะฑะฝะพะฒะปะตะฝะธะน

---

## ะะปะพััะฐัะธะน

| ะขะตัะผะธะฝ | ะะฟะธัะฐะฝะธะต |
|--------|----------|
| ะะฐะฝะฐะป | ะกััะฐะฝะธัะฐ ะฟะพะปัะทะพะฒะฐัะตะปั Rutube ั ะฒะธะดะตะพ |
| ะะตัะฐะดะฐะฝะฝัะต | ะะฝัะพัะผะฐัะธั ะพ ะฒะธะดะตะพ (ะฝะฐะทะฒะฐะฝะธะต, ะพะฟะธัะฐะฝะธะต, ะดะฐัะฐ) |
| ะคัะฐะณะผะตะฝั | ะงะฐััั ะฒะธะดะตะพัะฐะนะปะฐ ะฟัะธ ะฟะฐัะฐะปะปะตะปัะฝะพะน ะทะฐะณััะทะบะต |
| ะัั ะผะตัะฐะดะฐะฝะฝัั | ะคะฐะนะป metadata.json ั ัะพััะฐะฝัะฝะฝะพะน ะธะฝัะพัะผะฐัะธะตะน ะพ ะฒะธะดะตะพ |

---

## ะะพะฝัะฐะบัั ะธ ะฟะพะดะดะตัะถะบะฐ

ะัะธ ะฒะพะทะฝะธะบะฝะพะฒะตะฝะธะธ ะฒะพะฟัะพัะพะฒ ะฟะพ ัะฐะทัะฐะฑะพัะบะต:
- ะัะพะฒะตัะธัั `rutube_logger.py` ะดะปั ะฟะพะฝะธะผะฐะฝะธั ะฒัะฒะพะดะฐ ะพัะธะฑะพะบ
- ะัะฟะพะปัะทะพะฒะฐัั `logger.debug()` ะดะปั ะพัะปะฐะดะบะธ
- ะคะฐะนะป `rutube_app.log` ัะพะดะตัะถะธั ะธััะพัะธั ะฒัะฟะพะปะฝะตะฝะธั